import{r as a,u as L,b as R,aq as K,ar as U,as as $,j as e}from"./index-Ck68-v7X.js";const I=a.createContext();function T({children:i}){var _,C;const{pop:m}=L(),s=a.useRef(null),{token:r,user:u}=R(),[w,x]=a.useState([]),[c,k]=a.useState(null),[n,f]=a.useState([]),[v,N]=a.useState(!1),b=a.useRef(null);a.useEffect(()=>{if(r?s.current=K(r):s.current=null,!(u!=null&&u.name))return;const o=U();b.current=o,$(r);const d=t=>{const y=t.chats.map(g=>({...g}));x(y)},l=t=>{console.log("üöÄ ~ handleNewChatAssigned ~ newChat:",t.roomId);const y=w.filter(g=>g.roomId==t.roomId);console.log("üöÄ ~ handleRestoreDashboard ~ a:",y),!(y.length>0)&&(m("B·∫°n c√≥ th√™m cu·ªôc chat m·ªõi","s"),x(g=>g.some(h=>h.roomId===t.roomId)?g:[{roomId:t.roomId,customerId:t.customerId,customerName:t.customerName,customerAvatar:t.customerAvatar,lastMessage:t.lastMessage||"Cu·ªôc tr√≤ chuy·ªán m·ªõi.",unreadMessageCount:t.unreadMessageCount||1,roomUpdatedAt:t.roomUpdatedAt},...g]))},p=t=>{var y;t.chat_room_id===c&&(f(g=>[...g,t]),b.current&&t.sender_id!=((y=s.current)==null?void 0:y.user_id)&&b.current.emit("mark_chat_as_read",{roomId:t.chat_room_id,messageId:t.id})),x(g=>g.map(h=>{var j;if(h.roomId===t.chat_room_id){const E=t.chat_room_id===c||t.sender_id==((j=s.current)==null?void 0:j.user_id)?0:(h.unreadMessageCount||0)+1;return{...h,lastMessage:t.content,unreadMessageCount:E,roomUpdatedAt:new Date().toISOString()}}return h}).sort((h,j)=>new Date(j.roomUpdatedAt)-new Date(h.roomUpdatedAt)))};return o.on("restore_agent_dashboard",d),o.on("new_chat_assigned",l),o.on("new_chat_message",p),()=>{o.off("restore_agent_dashboard",d),o.off("new_chat_assigned",l),o.off("new_chat_message",p)}},[r,c,u==null?void 0:u.name,(_=s.current)==null?void 0:_.user_id]);const A=a.useCallback(o=>{o===c||!b.current||(k(o),f([]),N(!0),b.current.emit("admin_get_chat_details",{roomId:o},d=>{var l;if(d.success){if(f(d.data.messages||[]),d.data.messages.length>0&&((l=s.current)!=null&&l.user_id)){const p=d.data.messages[d.data.messages.length-1].id;b.current.emit("mark_chat_as_read",{roomId:o,messageId:p})}}else alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ tin nh·∫Øn."),console.error(d.message);N(!1)}),x(d=>d.map(l=>l.roomId===o?{...l,unreadMessageCount:0}:l)))},[c,(C=s.current)==null?void 0:C.user_id]),S=a.useCallback(o=>{var l;if(!c||!s.current)return!1;const d={roomId:c,content:o,senderId:(l=s.current)==null?void 0:l.user_id};return b.current.emit("send_chat_message",d),!0},[c]),D={chatList:w,activeChatId:c,messages:n,isLoading:v,selectChat:A,sendMessage:S,refToken:s};return e.jsx(I.Provider,{value:D,children:i})}const M=()=>a.useContext(I);function z(){const{chatList:i,activeChatId:m,selectChat:s}=M();return e.jsxs("div",{className:"w-full sm:w-1/3 md:w-1/4 border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-gray-900 z-10",children:e.jsx("h2",{className:"text-2xl font-bold text-gray-700 dark:text-gray-300",children:"Tr√≤ chuy·ªán"})}),e.jsxs("ul",{className:"overflow-y-auto flex-grow",children:[i.map(r=>e.jsxs("li",{onClick:()=>s(r.roomId),className:`p-3 cursor-pointer transition-all duration-200 ease-in-out flex items-center space-x-4 border-l-4 ${r.roomId===m?"bg-blue-50 dark:bg-blue-900/20 border-blue-500":"border-transparent hover:bg-gray-100 dark:hover:bg-gray-800/50"}`,children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:r.customerAvatar||`https://ui-avatars.com/api/?name=${r.customerName||r.customerId}&background=e2e8f0&color=64748b`,alt:"Customer Avatar",className:"w-12 h-12 rounded-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-semibold text-gray-700 dark:text-gray-300 truncate",children:r.customerName||`Kh√°ch: ${r.customerId}`}),r.unreadMessageCount>0&&e.jsx("span",{className:"bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center flex-shrink-0",children:r.unreadMessageCount})]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm truncate",children:r.lastMessage||"Ch∆∞a c√≥ tin nh·∫Øn n√†o..."})]})]},r.roomId)),i.length===0&&e.jsx("div",{className:"p-6 text-center h-full flex items-center justify-center",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400 italic",children:"Kh√¥ng c√≥ cu·ªôc tr√≤ chuy·ªán n√†o."})})]})]})}function B({title:i,titleId:m,...s},r){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":m},s),i?a.createElement("title",{id:m},i):null,a.createElement("path",{d:"M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z"}))}const P=a.forwardRef(B);function O(){var k;const{messages:i,activeChatId:m,sendMessage:s,refToken:r}=M(),[u,w]=a.useState(""),x=a.useRef(null);a.useEffect(()=>{var n;(n=x.current)==null||n.scrollIntoView({behavior:"smooth"})},[i]);const c=()=>{u.trim()&&(s(u.trim()),w(""))};return m?e.jsxs("div",{className:"w-full sm:w-2/3 md:w-3/4 flex flex-col bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm sticky top-0 z-10",children:e.jsxs("h3",{className:"font-semibold text-lg text-gray-700 dark:text-gray-300",children:["Tr√≤ chuy·ªán v·ªõi ",((k=i[0])==null?void 0:k.sender_name)||"Kh√°ch h√†ng"]})}),e.jsxs("div",{className:"flex-1 p-6 overflow-y-auto space-y-6 bg-white dark:bg-gray-900",children:[i.map(n=>{var v;const f=n.sender_id==((v=r.current)==null?void 0:v.user_id);return e.jsx("div",{className:`flex items-end gap-3 max-w-xl ${f?"ml-auto flex-row-reverse":"mr-auto"}`,children:e.jsxs("div",{className:`p-3 rounded-2xl ${f?"bg-blue-600 text-white rounded-br-lg":"bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-bl-lg"}`,children:[e.jsx("p",{className:"text-base",children:n.content}),e.jsx("p",{className:`text-xs mt-2 text-right ${f?"text-blue-200":"text-gray-400 dark:text-gray-500"}`,children:new Date(n.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},n.id)}),e.jsx("div",{ref:x})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("textarea",{className:"flex-1 p-3 bg-gray-200 dark:bg-gray-800 border-transparent rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-300 placeholder-gray-500 dark:placeholder-gray-400",placeholder:"Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n...",value:u,onChange:n=>w(n.target.value),onKeyDown:n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),c())},rows:"1"}),e.jsx("button",{className:"p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 disabled:opacity-50",onClick:c,disabled:!u.trim(),children:e.jsx(P,{className:"h-6 w-6"})})]})})]}):e.jsx("div",{className:"w-full sm:w-2/3 md:w-3/4 flex flex-col items-center justify-center bg-white dark:bg-gray-900 p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","aria-hidden":"true",children:e.jsx("path",{vectorEffect:"non-scaling-stroke",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-gray-700 dark:text-gray-300",children:"B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:"Ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch b√™n tr√°i."})]})})}function q(){return e.jsx(T,{children:e.jsx("div",{className:"flex h-[86svh] bg-white dark:bg-gray-900",children:e.jsxs("div",{className:"flex w-full max-w-screen-2xl mx-auto rounded-2xl shadow-2xl overflow-hidden ring-1 ring-gray-200 dark:ring-gray-800",children:[e.jsx(z,{}),e.jsx(O,{})]})})})}export{q as default};
