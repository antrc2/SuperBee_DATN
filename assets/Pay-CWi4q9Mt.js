import{c as le,u as de,ag as me,r as n,l as xe,k as he,j as e,o as H,m as C,i as O,ax as ue,L as pe,az as W,X as J,I as ge,C as fe,e as N,T as be}from"./index-BDAcJp4Y.js";import{S as je}from"./shield-check-BsMhMPz-.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M10 12h11",key:"6m4ad9"}],["path",{d:"M10 18h11",key:"11hvi2"}],["path",{d:"M10 6h11",key:"c7qv1k"}],["path",{d:"M4 10h2",key:"16xx2s"}],["path",{d:"M4 6h1v4",key:"cnovpq"}],["path",{d:"M6 18H4c0-1 2-2 2-3s-1-1.5-2-1",key:"m9a95d"}]],ye=le("list-ordered",Ne),d=r=>{const x=Number(r);return isNaN(x)?"0 ₫":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(x)},ve=({isOpen:r,onClose:x,discounts:y,onApplyDiscount:v,appliedPromotionCode:h})=>r?e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"section-bg w-full max-w-lg max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-themed",children:[e.jsxs("h3",{className:"text-xl font-bold font-heading text-primary flex items-center",children:[e.jsx(be,{size:24,className:"mr-2 text-accent"}),"Mã Giảm Giá Của Bạn"]}),e.jsx("button",{onClick:x,className:"p-1 rounded-full text-secondary hover:text-primary hover:bg-white/10 transition-colors",children:e.jsx(J,{size:24})})]}),e.jsx("div",{className:"p-4 overflow-y-auto custom-scrollbar-notification",children:y.length===0?e.jsx("p",{className:"text-secondary text-center py-8",children:"Bạn không có mã giảm giá nào."}):e.jsx("ul",{className:"space-y-3",children:y.map(a=>e.jsx("li",{className:`selection-grid-item text-left p-4 ${h===a.code?"selection-grid-item-selected":""}`,children:e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(W,{size:20,className:"mr-2 text-accent"}),e.jsx("span",{className:"font-bold text-lg text-primary",children:a.code}),h===a.code&&e.jsx("span",{className:"ml-3 text-xs bg-green-500/20 text-green-500 px-2 py-0.5 rounded-full font-semibold",children:"Đang áp dụng"})]}),e.jsx("p",{className:"text-sm text-secondary mb-2",children:a.description||`Giảm ${a.value}%`}),e.jsxs("div",{className:"text-xs text-secondary/80 space-y-1 border-t border-themed pt-2 mt-2",children:[e.jsxs("p",{children:["HSD:"," ",e.jsx("span",{className:"font-medium",children:a.expiry==="N/A"?"Vô thời hạn":new Date(a.expiry).toLocaleDateDateString("vi-VN")})]}),a.min_discount_amount>0&&e.jsxs("p",{children:["Đơn tối thiểu:"," ",e.jsx("span",{className:"font-medium",children:d(a.min_discount_amount)})]}),a.max_discount_amount>0&&e.jsxs("p",{children:["Giảm tối đa:"," ",e.jsx("span",{className:"font-medium",children:d(a.max_discount_amount)})]})]})]}),e.jsx("button",{onClick:()=>{v(a.code),x()},disabled:h===a.code,className:"action-button action-button-primary text-sm !py-2 !px-4 self-center disabled:!bg-tertiary disabled:!text-primary/80 disabled:cursor-not-allowed disabled:filter-none disabled:transform-none",children:h===a.code?"Đã chọn":"Dùng ngay"})]})},a.id))})})]})}):null;function we(){const{pop:r,conFim:x}=de(),{fetchCartItems:y}=me(),[v,h]=n.useState([]),[a,F]=n.useState(0),[K,Q]=n.useState([]),[S,w]=n.useState(""),[i,j]=n.useState(null),[Y,T]=n.useState(!1),[D,Z]=n.useState(!1),[A,M]=n.useState(!0),[L,u]=n.useState(""),[B,z]=n.useState(!1),[P,ee]=n.useState(0),[R,k]=n.useState(0),[I,V]=n.useState(0),[se,G]=n.useState(0),[te,ae]=n.useState(0),[E,ne]=n.useState(0),_=xe(),{fetchUserMoney:re}=he();n.useEffect(()=>{(async()=>{var o,l,m;M(!0);try{const c=await N.get("/orders/checkout");if((o=c.data)!=null&&o.status){const g=c.data.carts.filter(s=>s.status===1).map(s=>{var f,b,X,$,q;return{id:s.id,product_id:s.product_id,name:((f=s.product)==null?void 0:f.sku)||"Sản phẩm không tên",image:(($=(X=(b=s.product)==null?void 0:b.images)==null?void 0:X[0])==null?void 0:$.image_url)||"https://placehold.co/100x100/E2E8F0/4A5568?text=Sản+phẩm",price:parseFloat(s.unit_price)||0,old_price:parseFloat((q=s.product)==null?void 0:q.price)||0}});h(g),F(parseFloat(c.data.balance)||0),ee(parseFloat(c.data.total_price)||0),k(parseFloat(c.data.total_price_after_discount)||0),V(parseFloat(c.data.tax_amount)||0),G(parseFloat(c.data.tax_value)||0),ae(parseFloat(c.data.discount_amount)||0),ne(parseFloat(c.data.discount_value)||0),Q(c.data.promotion_codes.map(s=>({id:s.id,code:s.code,description:s.description,type:"percentage",value:parseFloat(s.discount_value)||0,expiry:s.end_date||"N/A",min_discount_amount:parseFloat(s.min_discount_amount)||0,max_discount_amount:parseFloat(s.max_discount_amount)||0,per_user_limit:parseInt(s.per_user_limit)||-1,usage_limit:parseInt(s.usage_limit)||-1}))),j(null),w(""),u(""),g.length===0&&(r("Giỏ hàng của bạn đang trống.","info"),_("/cart"))}else r(c.data.message,"error"),_("/cart")}catch(c){console.error("Lỗi khi tải dữ liệu giỏ hàng:",c);const g=((m=(l=c.response)==null?void 0:l.data)==null?void 0:m.message)||"Lỗi khi tải dữ liệu giỏ hàng.";r(g,"error"),_("/cart")}finally{M(!1)}})()},[y,r,_]);const{subtotalBeforeTax:ce,finalAmount:p}=n.useMemo(()=>{const t=P;let o=R;return i&&(o=i.total_price_after_discount),{subtotalBeforeTax:t,finalAmount:o}},[P,R,i]),U=async(t=S)=>{var l,m,c,g;const o=t.trim().toUpperCase();if(o)u("");else{u("Vui lòng nhập mã giảm giá.");return}if(await x(`Bạn muốn áp dụng mã giảm giá "${o}"?`))try{const s=await N.post("/orders/check",{promotion_code:o});if(s.data.status)j({code:s.data.promotion_code,discount_amount:parseFloat(s.data.discount_amount)||0,discount_value:parseFloat(s.data.discount_value)||0,total_price_after_discount:parseFloat(s.data.total_price_after_discount)||0}),k(parseFloat(s.data.total_price_after_discount)||0),V(parseFloat(s.data.tax_value)||10),G(parseFloat(s.data.tax_amount)||0),r(s.data.message,"success"),w(""),u("");else{j(null),u(s.data.message);const f=await N.get("/orders/checkout");(l=f.data)!=null&&l.status&&k(parseFloat(f.data.total_price_after_discount)||0)}}catch(s){console.error("Lỗi khi kiểm tra mã giảm giá:",s);const f=((c=(m=s.response)==null?void 0:m.data)==null?void 0:c.message)||"Lỗi khi kiểm tra mã giảm giá.";u(f),j(null);try{const b=await N.get("/orders/checkout");(g=b.data)!=null&&g.status&&k(parseFloat(b.data.total_price_after_discount)||0)}catch(b){console.error("Error reverting total price:",b)}}},ie=async()=>{if(i&&await x("Bạn có chắc chắn muốn xóa mã giảm giá?")){j(null),w(""),u("");try{const t=await N.get("/orders/checkout");t.data.status?(k(parseFloat(t.data.total_price_after_discount)||0),r("Đã xóa mã giảm giá.","success")):r("Lỗi khi khôi phục giá gốc.","error")}catch(t){console.error("Lỗi khi xóa mã giảm giá:",t),r("Lỗi khi xóa mã giảm giá.","error")}}},oe=async()=>{var t,o;if(!D){r("Bạn cần đồng ý với điều khoản và dịch vụ trước khi thanh toán.","warning");return}if(p>a){r("Số dư không đủ. Vui lòng nạp thêm tiền.","error");return}z(!0);try{const l=await N.post("/orders/purchase",{promotion_code:(i==null?void 0:i.code)||null});l.data.status?(F(m=>m-p),h([]),j(null),r(l.data.message,"success"),await y(),await re(),_("/info/orders")):r(l.data.message,"error")}catch(l){console.error("Lỗi khi xử lý thanh toán:",l);const m=((o=(t=l.response)==null?void 0:t.data)==null?void 0:o.message)||"Lỗi khi xử lý thanh toán.";r(m,"error")}finally{z(!1)}};return A?e.jsx(H,{}):e.jsxs("div",{className:"min-h-screen relative",children:[B&&e.jsx(H,{}),e.jsxs("div",{className:"max-w-screen-xl mx-auto",children:[e.jsxs("div",{className:"breadcrumbs-container p-4",children:[e.jsx(C,{to:"/",className:"breadcrumb-link",children:"Trang chủ"}),e.jsx(O,{size:16,className:"breadcrumb-separator"}),e.jsx(C,{to:"/cart",className:"breadcrumb-link",children:"Giỏ hàng"}),e.jsx(O,{size:16,className:"breadcrumb-separator"}),e.jsx("span",{className:"text-primary font-semibold",children:"Thanh toán"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-8",children:e.jsxs("div",{className:"section-bg p-6",children:[e.jsxs("h2",{className:"text-xl font-bold font-heading mb-4 text-primary flex items-center",children:[e.jsx(ye,{size:24,className:"mr-3 text-accent"}),"Xem lại đơn hàng (",v.length,")"]}),e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar-notification",children:v.map(t=>e.jsxs("div",{className:"flex items-center gap-4 bg-input p-3 rounded-lg border border-themed",children:[e.jsx("img",{src:t.image,alt:t.name,className:"w-16 h-16 object-cover rounded-md shadow-sm"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:"font-semibold text-primary",children:t.name}),e.jsxs("p",{className:"text-sm text-secondary",children:["Giá gốc: ",d(t.old_price)]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"font-semibold text-primary",children:d(t.price)})})]},t.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"sticky top-24 space-y-8",children:[e.jsxs("div",{className:"section-bg p-6",children:[e.jsxs("h2",{className:"text-xl font-bold font-heading mb-4 text-primary flex items-center",children:[e.jsx(ue,{size:24,className:"mr-3 text-accent"}),"Ví của bạn"]}),e.jsxs("div",{className:`p-4 rounded-lg flex items-center justify-between gap-5 ${a>=p?"bg-tertiary/20":"bg-red-500/10"}`,children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-secondary",children:"Số dư khả dụng"}),e.jsx("p",{className:"text-2xl font-bold text-primary",children:d(a)})]}),a<p&&e.jsxs(C,{to:"/recharge-atm",className:"action-button action-button-primary !py-2 !px-4 text-sm",children:[e.jsx(pe,{size:16,className:"mr-2"}),"Nạp tiền"]})]}),a<p&&e.jsx("p",{className:"text-red-500 text-sm mt-2 font-semibold",children:"Số dư không đủ để thực hiện thanh toán."})]}),e.jsxs("div",{className:"section-bg p-6",children:[e.jsxs("h2",{className:"text-xl font-bold font-heading mb-4 text-primary flex items-center",children:[e.jsx(W,{size:24,className:"mr-3 text-accent"}),"Mã giảm giá"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"text",value:S,onChange:t=>w(t.target.value.toUpperCase()),placeholder:"Nhập mã của bạn ở đây",className:"flex-grow w-full bg-input text-input p-3 rounded-md border-hover placeholder-theme"}),e.jsx("button",{onClick:()=>U(),className:"action-button action-button-secondary !py-3 !px-6",children:"Áp dụng"})]}),L&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:L}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsx("button",{onClick:()=>T(!0),className:"text-sm text-accent hover:brightness-125 font-medium",children:"Xem danh sách mã giảm giá"}),i&&e.jsxs("button",{onClick:ie,className:"text-xs text-red-500 hover:underline flex items-center",children:[e.jsx(J,{size:12,className:"mr-1"}),' Gỡ mã "',i.code,'"']})]})]}),e.jsxs("div",{className:"section-bg p-6",children:[e.jsxs("h2",{className:"text-xl font-bold font-heading mb-4 text-primary flex items-center",children:[e.jsx(ge,{size:24,className:"mr-3 text-accent"}),"Tổng kết thanh toán"]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-secondary",children:"Giá gốc sản phẩm"}),e.jsx("div",{className:"flex-grow border-b border-dashed border-themed mx-2"}),e.jsx("span",{className:"font-medium text-primary",children:d(ce)})]}),E>0&&e.jsxs("div",{className:"flex items-center justify-between text-tertiary",children:[e.jsxs("span",{className:"font-semibold",children:["Chiết khấu hạng (",E,"%)"]}),e.jsx("div",{className:"flex-grow border-b border-dashed border-tertiary/50 mx-2"}),e.jsxs("span",{className:"font-semibold",children:["-",d(te)]})]}),i&&e.jsxs("div",{className:"flex items-center justify-between text-accent",children:[e.jsxs("span",{className:"font-semibold",children:['Mã giảm giá "',i.code,'"']}),e.jsx("div",{className:"flex-grow border-b border-dashed border-accent/50 mx-2"}),e.jsxs("span",{className:"font-semibold",children:["-",d(i.discount_amount)]})]}),I>0&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-secondary",children:["Thuế (",se,"%)"]}),e.jsx("div",{className:"flex-grow border-b border-dashed border-themed mx-2"}),e.jsxs("span",{className:"font-medium text-primary",children:["+",d(I)]})]})]}),e.jsx("div",{className:"border-t border-themed mt-4 pt-4",children:e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-lg font-semibold text-primary",children:"Tổng thanh toán"}),e.jsx("span",{className:"font-bold text-red-500 text-3xl",children:d(p)})]})})]}),e.jsxs("div",{className:"section-bg p-6",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("label",{htmlFor:"terms",className:"flex items-start text-sm text-secondary cursor-pointer",children:[e.jsx("input",{type:"checkbox",id:"terms",checked:D,onChange:t=>Z(t.target.checked),className:"h-4 w-4 mr-3 mt-0.5 rounded"}),e.jsxs("span",{children:["Tôi đã đọc và đồng ý với các"," ",e.jsx(C,{to:"/terms",className:"text-accent hover:underline font-medium",children:"điều khoản và dịch vụ"})," ","của trang web."]})]})}),e.jsxs("button",{onClick:oe,disabled:A||p>a||v.length===0||B,className:"action-button action-button-primary w-full text-lg !py-4",children:[e.jsx(fe,{className:"inline-block mr-3",size:24}),"Xác nhận & Thanh toán"]}),e.jsx("div",{className:"mt-4 text-xs text-secondary text-center",children:e.jsxs("p",{className:"flex items-center justify-center",children:[e.jsx(je,{size:14,className:"mr-2 text-tertiary"}),"Tất cả giao dịch đều được mã hóa và bảo mật."]})})]})]})})]})]}),e.jsx(ve,{isOpen:Y,onClose:()=>T(!1),discounts:K,onApplyDiscount:U,appliedPromotionCode:i==null?void 0:i.code})]})}export{we as default};
